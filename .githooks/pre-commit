#!/bin/bash

# Pre-commit hook for Flutter project
# Runs: format ‚Üí analyze ‚Üí test
# Cross-platform compatible (macOS, Linux, Windows Git Bash)

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üöÄ Running pre-commit checks...${NC}"

# Get staged files
STAGED_DART_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.dart$' | grep -v '\.g\.dart$' | grep -v 'generated/' || true)

if [ -z "$STAGED_DART_FILES" ]; then
  echo -e "${YELLOW}[INFO] No Dart files to process${NC}"
  exit 0
fi

# 1. Format Dart files
echo -e "\n${YELLOW}üìù Formatting Dart files...${NC}"
if ! dart format --line-length=120 --set-exit-if-changed $STAGED_DART_FILES; then
  echo -e "${RED}‚ùå Formatting failed${NC}"
  echo -e "${YELLOW}Run: dart format --line-length=120 --fix $STAGED_DART_FILES${NC}"
  exit 1
fi
echo -e "${GREEN}‚úì Formatting passed${NC}"

# Re-stage formatted files
git add $STAGED_DART_FILES

# 2. Analyze code
echo -e "\n${YELLOW}üîç Running Flutter analyze...${NC}"
if ! flutter analyze --no-pub; then
  echo -e "${RED}‚ùå Analysis failed${NC}"
  exit 1
fi
echo -e "${GREEN}‚úì Analysis passed${NC}"

# 3. Run tests (optional - can be slow)
echo -e "\n${YELLOW}üß™ Running tests...${NC}"
if command -v flutter &> /dev/null; then
  # Only run tests if changes are in lib/ or test/
  if echo "$STAGED_DART_FILES" | grep -qE '(lib/|test/)'; then
    if ! flutter test --coverage; then
      echo -e "${RED}‚ùå Tests failed${NC}"
      exit 1
    fi
    echo -e "${GREEN}‚úì Tests passed${NC}"
  fi
fi

echo -e "\n${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0

