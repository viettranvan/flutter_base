#!/usr/bin/env sh
set -e

# ===============================
# Colors (portable)
# ===============================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
  printf "%b\n" "$1"
}

log "${GREEN}üöÄ Running Flutter pre-commit checks...${NC}"

# ===============================
# Check dependencies
# ===============================
command -v flutter >/dev/null 2>&1 || {
  log "${RED}‚ùå Flutter not found in PATH${NC}"
  exit 1
}

command -v dart >/dev/null 2>&1 || {
  log "${RED}‚ùå Dart not found in PATH${NC}"
  exit 1
}

# ===============================
# Get staged Dart files
# ===============================
STAGED_DART_FILES=$(git diff --cached --name-only --diff-filter=ACM \
  | grep '\.dart$' \
  | grep -v '\.g\.dart$' \
  | grep -v 'generated/' || true)

# ===============================
# 1. Format staged Dart files
# ===============================
if [ -n "$STAGED_DART_FILES" ]; then
  log "${YELLOW}üìù Formatting staged Dart files...${NC}"
  dart format --line-length=120 --set-exit-if-changed $STAGED_DART_FILES
  git add $STAGED_DART_FILES
  log "${GREEN}‚úì Formatting passed${NC}"
else
  log "${YELLOW}[INFO] No Dart files to format${NC}"
fi

# ===============================
# 2. Analyze
# ===============================
log "${YELLOW}üîç Running flutter analyze...${NC}"
flutter analyze
log "${GREEN}‚úì Analysis passed${NC}"

# ===============================
# 3. Test (unit only)
# ===============================
if [ -d "test" ]; then
  log "${YELLOW}üß™ Running flutter test...${NC}"
  flutter test
  log "${GREEN}‚úì Tests passed${NC}"
fi

log "${GREEN}‚úÖ All pre-commit checks passed!${NC}"